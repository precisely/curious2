echo "Enter the database name for this server, i.e., 'curious'"

read DBNAME

echo "Enter the database user name, i.e., 'curious'"

read DBUSERNAME

echo "Enter database curious user password"

read DBPASSWORD

echo "Enter unique name for backup identification"

read DBACKUPNAME

INSTALLDIR=~/installdb
chmod +x ~/deploymentbin/*

cd ~
mkdir .ssh
chmod 700 .ssh
chmod 700 $INSTALLDIR
chmod 600 .ssh/authorized_keys
rm -f .ssh/authorized_keys
cp -f $INSTALLDIR/authorized_keys ./.ssh
chmod 400 .ssh/authorized_keys
yum -y update
yum -y install yum-cron
cp /usr/share/zoneinfo/UTC /etc/localtime
iptables -i eth1 -I INPUT -p tcp --dport 3306 -j ACCEPT
service iptables save
yum -y install lynx
yum -y install zip
yum -y install unzip

# install git

yum -y install git

# install curious user

adduser curious
chmod o-rwx /home/curious
rm -rf /home/curious/installcurious
mkdir /home/curious/installcurious
chmod 700 /home/curious/installcurious
cp $INSTALLDIR/* /home/curious/installcurious
rm -rf /home/curious/deploymentbin
cp -rpv ~/deploymentbin /home/curious/deploymentbin
chmod +x /home/curious/installcurious/installcurious
chown -R curious.curious /home/curious/installcurious
chown -R curious.curious /home/curious/deploymentbin
mkdir /home/curious/www
chmod 750 /home/curious/www
chown -R curious.apache /home/curious/www
su -l curious -c /home/curious/installcurious/installcurious

# install database

yum -y install mariadb-server
service mariadb start
echo "Set the root password and answer yes to all other questions"
mysql_secure_installation
chkconfig --level 345 marisdb on
rm -f $INSTALLDIR/curiousinit.sql
cp $INSTALLDIR/curiousinit_template.sql $INSTALLDIR/curiousinit.sql
~/deploymentbin/replaceword "DBNAME" "$DBNAME" $INSTALLDIR/curiousinit.sql
~/deploymentbin/replaceword "DBPASSWORD" "$DBPASSWORD" $INSTALLDIR/curiousinit.sql
echo "Please reenter the root password you just entered"
mysql -u root -p <$INSTALLDIR/curiousinit.sql

# create my.cnf for curious user

if [ -f /home/curious/.my.cnf ];
then
	chmod 600 /home/curious/.my.cnf
	~/deploymentbin/replaceline /home/curious/.my.cnf "password=" "password=$DBPASSWORD"
else
	cp $INSTALLDIR/my.cnf /home/curious/.my.cnf
	chmod 600 /home/curious/.my.cnf
	chown curious.curious /home/curious/.my.cnf
	~/deploymentbin/replaceline /home/curious/.my.cnf "password=" "password=$DBPASSWORD"
fi

rm -f /home/curious/bin/backup
cp $INSTALLDIR/backup_template /home/curious/bin/backup
chmod 700 /home/curious/bin/backup
chown curious.curious /home/curious/bin/backup
~/deploymentbin/replaceword /home/curious/bin/backup "DBNAME" "$DBNAME"
~/deploymentbin/replaceword /home/curious/bin/backup "DBBACKUPNAME" "$DBBACKUPNAME"
rm -f /etc/cron.daily/backupcurious
cp $INSTALLDIR/backupcurious /etc/cron.daily

echo "Remember to edit /etc/hosts to add the local IP address for curiousbackup."
